---
title: Windows环境中C++遍历目录及文件
date: 2023-03-30 20:56:54
tags: [技术, C++, Windows]
categories: 技术
index_img: /images/windows_logo.png
banner_img: /images/l83rrl.png
author: shuhui
---
这里记录的是在Windows环境下，如何遍历目录以及文件，其中分为两种情况，一种是遍历目录下的所有目录和文件，另一种是遍历目录里的所有文件，包括子目录，因此需要递归调用函数来实现。

### 1.使用Windows API遍历目录下的所有文件
遍历某个目录下的所有文件，并输出文件名和文件大小。
```cpp
#include <iostream>
#include <Windows.h>
#include <cstring>

using namespace std;

void listFile(const char * dir)
{
	HANDLE hFind;
	WIN32_FIND_DATA findData;
	LARGE_INTEGER size;
	hFind = FindFirstFile(dir, &findData);
	if (hFind == INVALID_HANDLE_VALUE)
	{
		cout << "Failed to find first file!\n";
		return;
	}
	do
	{
		// 忽略"."和".."两种结果
		if (strcmp(findData.cFileName, ".") == 0 || strcmp(findData.cFileName, "..") == 0)
		{
			continue;
		}
		if (findData.dwFileAttributes & FILE_ATTRIBUTE_DIRECTORY)	// 判断是否是目录
		{
			cout << findData.cFileName << "\t <dir>\n";
		}
		else
		{
			size.LowPart = findData.nFileSizeLow;
			size.HighPart = findData.nFileSizeHigh;
			cout << findData.cFileName << "\t" << size.QuadPart << " bytes\n";
		}
	} while (FindNextFile(hFind, &findData));
    FindClose(hFind);
	cout << "Done.\n";
}

int main()
{
	char dir[100];
	cout << "Enter a directory (ends with \'\\\'): ";
	cin.getline(dir, 100);
	strcat_s(dir, "*.*");			// 需要在目录后面加上*.*表示所有目录文件
	listFile(dir);
	return 0;
}
```

NOTE: 在Visual Studio 2019中会出现“`"const char *" 类型的实参与 "LPCWSTR" 类型的形参不兼容`”的错误，该错误是由于vs使用的字符集为Unicode，解决办法是：在项目属性管理器->属性->高级->字符集，选择“使用多字节字符集”。

### 2.使用Windows API遍历目录里的所有文件
遍历目录里的所有文件，其中包括子目录和子目录里的文件，与前一节类似，只需迭代调用listFiles函数即可。
```cpp
#include <iostream>
#include <cstring>
#include <windows.h>

using namespace std;

void listFiles(const char* dir);

int main()
{

    char dir[100];
    memset(dir, 0, 100);
    cout << "Enter a directory (do not add \'\\\' in the end): ";
    cin.getline(dir, 100);

    //char dir[100] = "G:\\Nessus\\";

    listFiles(dir);
    return 0;
}

void listFiles(const char* dir)
{

    HANDLE hFind;
    WIN32_FIND_DATA findData;
    LARGE_INTEGER size;
    char dirNew[100];
    memset(dirNew, 0, 100);

    // 向目录加通配符，用于搜索第一个文件 
    strcpy(dirNew, dir);
    strcat(dirNew, "\\*.*");

    hFind = FindFirstFile(dirNew, &findData);
    do
    {
        // 是否是文件夹，并且名称不为"."或".." 
        if ((findData.dwFileAttributes & FILE_ATTRIBUTE_DIRECTORY) != 0
            && strcmp(findData.cFileName, ".") != 0
            && strcmp(findData.cFileName, "..") != 0
            )
        {
            // 将dirNew设置为搜索到的目录，并进行下一轮搜索 
            strcpy(dirNew, dir);
            strcat(dirNew, "\\");
            strcat(dirNew, findData.cFileName);
            listFiles(dirNew);
        }
        else
        {
            size.LowPart = findData.nFileSizeLow;
            size.HighPart = findData.nFileSizeHigh;
            cout << findData.cFileName << "\t" << size.QuadPart << " bytes\n";
        }
    } while (FindNextFile(hFind, &findData));

    FindClose(hFind);
}
```
NOTE: 在某些机器中会出现输出"烫烫烫"的乱码错误，可能是由于字符串未初始化或者机器原因，我在个人电脑上就存在这个问题一直没有解决。

### 3.使用io.h遍历目录下的所有文件
```cpp
#include <iostream>
#include <cstring>
#include <io.h>

using namespace std;

void listFiles(const char* dir);

int main()
{
	char dir[200];
	memset(dir, 0, 200);
	cout << "Enter a directory ( ends with \'\\\'): ";
	cin.getline(dir, 200);
	strcat(dir, "*.*");		// 在要遍历的目录后面加上通配符
	listFiles(dir);

	return 0;
}

void listFiles(const char* dir)
{
	intptr_t handle;
	_finddata_t findData;

	handle = _findfirst(dir, &findData);	// 查找目录中的第一个文件
	if (handle == -1)
	{
		cout << "Failed to find the first file!" << endl;
		return;
	}

	do
	{
		// 判断是否为子目录，且不是"."和".."
		if (findData.attrib & _A_SUBDIR 
			&& strcmp(findData.name, ".") != 0 && strcmp(findData.name, "..") != 0)
		{
			cout << findData.name << "\t<dir>" << endl;
		}
		else
		{
			cout << findData.name << "\t" << findData.size << endl;
		}
	} while (_findnext(handle, &findData)==0);		// 查找目录中的下一个文件

	_findclose(handle);			// 关闭搜索句柄
}
```
NOTE: 虽然在Linux系统中也可以使用```#include <sys/io.h>```, 但是似乎由于io.h可能存在跨平台不兼容的问题，因此在Windows中会出现问题。
### 4.使用io.h遍历目录里的所有文件
```cpp
#include <iostream>
#include <cstring>
#include <io.h>

using namespace std;

void listFiles(const char* dir);

int main()
{
	char dir[200];
	memset(dir, 0x00, 200);
	cout << "Enter a directory (ends with \'\\\'): ";
	cin.getline(dir, 200);

	listFiles(dir);

	return 0;
}

void listFiles(const char* dir)
{
	char dirNew[200];
	memset(dirNew, 0x00, 200);
	strcpy(dirNew, dir);
	strcat(dirNew, "\\*.*");

	intptr_t handle;
	_finddata_t findData;
	handle = _findfirst(dirNew, &findData);
	if (handle == -1)
	{
		cout << "Failed to find the first file!\n";
		return;
	}

	do
	{
		if (findData.attrib & _A_SUBDIR)
		{
			if (strcmp(findData.name, ".") == 0 || strcmp(findData.name, "..") == 0)
			{
				continue;
			}
			cout << findData.name << "\t<dir>\n";

			strcpy(dirNew, dir);
			strcat(dirNew, "\\");
			strcat(dirNew, findData.name);

			listFiles(dirNew);
		}
		else
		{
			cout << findData.name << "\t" << findData.size <<"bytes" << endl;
		}
	} while (_findnext(handle, &findData)==0);

	_findclose(handle);
}
```

### Inference
[1] https://www.cnblogs.com/collectionne/p/6792301.html
[2] https://www.cnblogs.com/collectionne/p/6815924.html
